\section{Closed-Loop Optimisation Method}
\label{ch1:sec:closed-loop-optimisation-method}

In the previous two sections, the key network parameters and associated cost functions have been established.
Then the used network models, data and battery models were explained.
Now, the implemented method on generating a traditional ESMU schedules is presented, before presenting the novel approach of adjusting this schedule using on-line readings.

\subsection{ESMU Schedule Generation}
\label{ch1:subsec:esmu-schedule-generation}

As discussed in the literature review in Chapter \ref{ch-review}, the main goals when scheduling battery operation are to achieve ``valley-filling'' and ``peak-shaving'' behaviour.
It has been identified, that both the Peak-to-Average Ratio (PAR) as well as the min-max-difference (MMD) are good indicators of how well the pursued behaviours have been implemented.
Therefore, a half-hourly PAR scheduling cost, $\zeta_\text{PAR}(\textbf{s}_\text{ESMU} + \textbf{s}_\text{network load})$, and a half-hourly MMD scheduling cost, $\zeta_\text{MM}(\textbf{s}_\text{ESMU} + \textbf{s}_\text{network load})$, are defined as follows:

\input{_chapter1/equ/peak-to-average-definition}

\input{_chapter1/equ/min-max-difference-definition}

\nomenclature{$\zeta_\text{PAR}(\textbf{s}$}{Cost of the underlying power profile $\textbf{s}$, based on the Peak to Average Ratio (PAR) (Chapter \ref{ch1})}
\nomenclature{$\zeta_\text{PAR}(\textbf{s}$}{Cost of the underlying power profile $\textbf{s}$, based on the difference between Minimum and Maximum power (MM) (Chapter \ref{ch1})}

Both costs are functions of the entire half-hourly ESMU schedule, $\textbf{s}_\text{ESMU}$, and the entire half-hourly network load profile, $\textbf{s}_\text{network load}$, where only the ESMU schedule is adjustable by an optimisation algorithm.
For this piece of work, a Sequential Quadratic Programming (SQP) approach was chosen to solve the following minimisation problem.
Reasons behind this choice are the SQP's robustness and speed, since it is built on the well established Newton-Raphson Method, as well as its ability to cope with nonlinear constraints.
It is this latter point that is most important, since the battery model's solving constraints are inherently nonlinear; the Newton-Raphson Method by itself is unable to solve with this kind of nonlinear constraints.
The final minimisation problem that was passed into the SQP solver can be formulated as:

\input{_chapter1/equ/scheduling-cost}

To summarise, this operation therefore minimises two costs by adjusting the half-hourly ESMU schedule, $\textbf{s}_\text{ESMU}$, given a certain constant half-hourly network load (or forecast) $\textbf{s}_\text{network load}$.
These two costs both capture the PAR and MMD of the resulting power profile, and when minimised to zero, indicate a perfectly flat power curve.
The minimisation is constrained to not exceed the battery's maximum charge/discharge rate (i.e. $s_\text{bat}(k) \leq C_f \times C_\text{bat} \forall k$), to not exceed the PMU's phase power rating (i.e. $\left|s_{\text{ESMU},\phi}(k)\right| \leq S_\text{rating} \forall \phi \forall k$), and to not over- or under-charge the battery (i.e. $0 \leq SOC(k) \leq 1 \forall k$).

For the work presented in this chapter, the supplied half-hourly network load (or forecast) was extrapolated from sub-half-hourly data.
This forecast can be seen as if it had been generated with perfect foresight.
Treating it in such a way does not further skew the already imperfect performance that is obtained when applying the resulting half-hourly schedule.
Therefore, any additional improvement or worsening is the result of the sub-half-hourly schedule adjustments.
In the following figure, a visualisation is provided where the impact of this half-hourly ESMU schedule becomes apparent.

\input{_chapter1/fig/improved-network-power}

Figure \ref{ch1:fig:improved-network-power} shows the original half-hourly network load and the improved network when adding the half-hourly ESMU schedule.
For this preliminary result, no network simulations have been carried out, as it should show an idea ESMU impact on the network's load.
This positive impact can be seen, since the half-hourly profile in Figure \ref{ch1:subfig:improved-half-hourly-network-power} is dominated by an evening peak in demand.
However, the actual sub-half-hourly demand, as it is plotted in Figure \ref{ch1:subfig:improved-sub-half-hourly-network-power}, has a much larger demand spike during the morning hours, which is not addressed as strongly as the evening peak.
Therefore, the compared peak power shaving dropped from 9.46kW to only 6.36kW, although only 50\% of the battery's discharge capacity is used.
Nonetheless, the overall improvement yielded by the ESMU schedule is still noticeable (given that it was scheduled using perfect half-hourly foresight). 

In the following section, the underlying closed-loop schedule adjustment method is explained, where it will be shown how individual key network parameters can be positively impacted without deviating from this already optimised half-hourly schedule.
The constraint of having to follow this half-hourly ESMU schedule is lifted in Chapter \ref{ch2}, where a real-time schedule adjustment method is proposed and researched.

\subsection{Closed-Loop Schedule Adjustment}

To quickly summarise, the following key network parameters are used in this chapter:

\begin{itemize}
	\item substation phase voltages, $v_{ss,\phi}(t) \in \textbf{v}_{ss}(t)$,
	\item ESMU phase voltages, $v_{\text{ESMU},\phi}(t) \in \textbf{v}_\text{ESMU}(t)$,
	\item all load voltages, $v_{load,i}(t) \in \textbf{v}_\text{load}(t)$,
	\item substation apparent phase power, $s_{ss,\phi}(t) \in \textbf{s}_{ss}(t)$,
	\item substation phase currents, $i_{ss,\phi}(t) \in \textbf{i}_{ss}(t)$,
	\item all line currents, $i_{\text{line},l,\phi}(t) \in \textbf{i}_\text{line}(t)$, and
	\item all network losses, $s_\text{losses}(t)$.
\end{itemize}

Together with these key network parameters, and the cost functions defined in Section \ref{ch1:sec:key-network-parameters}, a weighted sum of all costs is generated and formalised into the following global cost function:

\input{_chapter1/equ/weighted-sum-cost-function}

Here, $\boldsymbol{\alpha}$ is a binary choice vector, with which the weight of the global cost function can easily be adjusted.
In other words, this vector allows to target the network improvement based by focusing on a specific cost, rather than optimising the network operation based on the complete set of (sometimes contradicting) costs.
Since all key network parameters are outputs of the power flow simulations and not directly adjustable, and for simpler notations throughout this section, the global cost function is shortened to $\zeta(\boldsymbol{\alpha})$.

\input{_chapter1/fig/closed-loop-optimisation}

The underlying method that performs the proposed closed-loop optimisation is captured in the next Figure \ref{ch1:fig:closed-loop-optimisation}.
Here, for each time slot, $t$, a pre-scheduled ESMU power vector, $\textbf{s}_\text{ESMU}(t)$, is extracted and adjusted by an offset vector, $\delta \textbf{s}_\text{ESMU}(t)$.
This offset vector is found through the aforementioned optimiser that minimises the global cost function, $\zeta(\boldsymbol{\alpha})$, by repetitively running power flow simulations of the IEEE distribution feeder.
Once the adjusted ESMU schedule (i.e. $\textbf{s}_\text{ESMU}(t) + \delta \textbf{s}_\text{ESMU}(t)$) is no longer changed by the optimiser, the closed-loop optimisation process ends and the simulation continues to the next time slot (i.e. $t+1$).

Since $\delta \textbf{s}_\text{ESMU}(t)$ must not impact the underlying half-hourly ESMU schedule, one more constraint is defined.
This constraint assures that the sum of all phase powers in the adjustment vector equates to zero, hence keeping the internal battery's dis/charging power the same.
Including the previously mentioned battery system constraints, which ensure that the ESMU operates within its technical limitations (e.g. to not over- or undercharge the battery), the minimisation problem for the closed-loop optimisation mechanism can be formulated as follows:

\input{_chapter1/equ/closed-loop-minimisation}


\subsection{Method Execution and Result Assessment Procedure}
\label{ch1:subsec:method-execution}

After having established what parameters to focus on when trying to improve network operation, and after having established how the closed-loop optimising method aims to achieve this improvement, the performance assessment for the improvement method is introduced now.
To support the explanation of the evaluation procedure, the entire assessment procedure is captured in Figure \ref{ch1:fig:method-evaluation-flowchart}.

\input{_chapter1/fig/method-evaluation-flowchart}

All in all, there are eleven datasets of simulation results to be assessed and compared.
These results are obtained from a \textit{base} simulation, a \textit{normal} simulation and nine additional simulations where individual cost-functions were minimised.
More specifically, the \textit{base} case is the outcome of running an entire day of power profiles without any ESMU intervention.
This case represents the baseline or network performance which should be improved by any ESMU intervention.
The \textbf{normal} case captures the simplest of all ESMU interventions, since for this case, the ESMU executes its normal half-hourly schedule without any additional schedule modification.
Comparing the \textit{base} and \textit{normal} cases dies show the direct impact of the ESMU on the network's operation.
As mentioned above, the remaining nine datasets are results of nine different cases where the ESMU schedule is adjusted on a sub-half-hourly level.
The adjustment for each case is designed to minimise one underlying cost-function, whilst conforming to the ESMU's overall half-hourly charging and discharging profile.
In order to treat each cost-function separately $\boldsymbol{\alpha}$ is set to focus on each cost independently, e.g. by setting $\alpha_1 = 1 \text{ and } \alpha_2 = \alpha_3 = \dots = \alpha_9 = 0$.
For simplicity, the flowchart in Figure \ref{ch1:fig:method-evaluation-flowchart} abbreviates the specific costs by only indicating which entry in the $\boldsymbol{\alpha}$ vector is set to $1$, e.g. $\zeta(\alpha_1=1)$ for the preceding example.

All eleven datasets are then assessed in the same manner in order to compare the impact they had had on the network performance.
This underlying assessment is broken into three parts for each dataset:

\begin{enumerate}
	\item \textbf{Time Series Analysis} - 
	The underlying raw profiles are plotted and compared against their respective counterpart cases, in order to link the immediate network impacts to their physical meaning.
	For the same profiles, their corresponding cost profiles are calculated plotted.
	This is done to to highlight how the profiles are interpreted by the cost-functions in terms of improvement (i.e. lower cost) or worsening (i.e. increased cost).
	\item \textbf{Difference Analysis} - 
	The difference in cost profiles, compared to the respective \textit{base} or \textit{normal} case, is calculated and boxplots of these differences are presented to show a statistical spread of improvements or worsening.
	For these plots, a generally positive boxplot skew indicates a general improvement of the underlying network parameters, whilst a generally negative skew does indicate worse performance in regards to the underlying network parameters.
	\item \textbf{Probability Density Analysis} - 
	A set of Probability Density Functions (PDF) is derived for each cost profile using the well established kernel density estimation.
	These PDFs indicate the probability that a certain cost value occurs.
	An improvement is noted when the PDF is shifted towards the lower cost values, whereas a shift towards higher cost values worsened the network performance.
\end{enumerate}





