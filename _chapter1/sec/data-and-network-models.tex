\section{Data, models and storage scheduling}
\label{ch1:sec:data-and-network-models}

In this section the used power data is presented first.
Then the network model, from which all aforementioned key network parameters are extracted, and the battery model are explained.
In the end, the scheduling procedure is detailed.

\subsection{Load profiles}

\nomenclature[I]{$s_\text{net}(t)$}{Apparent network load at time $t$, where $s_\text{net}(t) \in \mathbb{C}$ (Chapter \ref{ch1})}
\nomenclature[I]{$s_{\text{load},i}(t)$}{Apparent load power for load $i$ at time $t$, where $(s_{\text{load},i}(t)) = \textbf{s}_\text{load}(t)$ and $s_{\text{load},i}(t) \in \mathbb{C}$ (Chapter \ref{ch1})}
\nomenclature[I]{$\textbf{s}_\text{load}(t)$}{Apparent load power vector of all loads at time $t$, where $\textbf{s}_\text{load}(t) \in \mathbb{C}^{I}$ (Chapter \ref{ch1})}

Alongside the LV Test Case model, the IEEE published 100 minutely demand profiles; each profile lasting 24h.
Therefore, by assigning one load profile to each customer, a series of 1440 snapshot simulations could be run in OpenDSS in order to simulate the variation and volatility in demand over the entire day.
A standardised power factor of 0.95 was used for all loads to calculate their reactive component.
The apparent network power, $s_\text{net}(t)$, is therefore defined for each time-step, $t$, as the aggregate of all load apparent powers, $\textbf{s}_\text{load}(t)$:

\input{_chapter1/equ/sub-half-hourly-network-load}

This demand profile does not take into account the distribution losses.
Nonetheless, it functions as a simple time-series to schedule ESMU operation, which is detailed in Section \ref{ch1:subsec:esmu-scheduling}.

\subsection{Network model}
\label{ch1:subsec:standardised-network-model}

The IEEE Power and Energy Society (IEEE-PES) provides several multi-node test cases.
These test cases used to be limited to distribution networks in the United States.
In 2015 however, they published a standardised model of a LV distribution network for the UK power network.
This model is called the ``European Low Voltage Test Feeder'' \cite{DistributionTestFeeders2017}.
Within the context of this work, this feeder is referred to as the ``LV Test Case'' and a network plot of this feeder has been included for reference.

\input{_chapter1/fig/network-plot-LVTestCase}

A substation (triangle in north west) provides power to the feeder, and the power magnitude is visualised by the thickness of the feeder's lines.
In total, there are 55 single-phase households connected to the substation, which represents a medium-sized, unbalanced UK feeder.

\subsection{Battery model}

\nomenclature[I]{$S_\text{rating}$}{Rating of battery's power electronics, where $S_\text{rating} \in \mathbb{R}_{>0}$ (Chapter \ref{ch1})}

The ESMU systems that were deployed throughout the NTVV project consisted of two parts: the Power Management Unit (PMU) and the Energy Storage Unit (ESU).
The PMU controls three-phase powers and links the ESU to the grid.
Each PMU's single-phase power rating, $S_\text{rating}$, is 12kVA and can also perform filtering functions beside battery charging and discharging, e.g. compensating for harmonic distortion, reactive power and phase unbalance.
The ESU is a modular container of 12.5kWh of Li-Ion energy storage that can be aggregated to increase the total energy storage capacity.
All battery monitoring, conditioning and regulation is performed within the ESU and hence lies outside the scope of this work.
However, control instructions that are sent to the ESMU system should not request the device to operate outside its own specifications, i.e. avoid under- or over-charge.

\nomenclature[I]{$C_\text{bat}$}{Battery capacity, where $C_\text{bat} \in \mathbb{R}_{>0}$ (Chapter \ref{ch1})}
\nomenclature[I]{$E_\text{bat}(t)$}{Energy stored in battery at time $t$, where $E_\text{bat}(t) \in \mathbb{R}_{>0}$ (Chapter \ref{ch1})}
\nomenclature[I]{$\eta$}{Round-trip efficiency of power electronics, where $\eta \in (0, 1]$ (Chapter \ref{ch1})}
\nomenclature[I]{$p_\text{bat}(t)$}{Single-phase active battery power at time $t$, where $p_\text{bat}(t) \in \mathbb{R}$ (Chapter \ref{ch1})}
\nomenclature[I]{$s_{\text{ESMU},\phi}(t)$}{Single-phase apparent ESMU power for phase $\phi$ at time $t$, where $(s_{\text{ESMU},\phi}(t)) = \textbf{s}_\text{ESMU}(t)$ and $s_{\text{ESMU},\phi}(t) \in \mathbb{Z}$ (Chapter \ref{ch1})}

In order to simulate this ESMU system and its energy storing behaviour, a model is developed from the given device specifications.
This model includes an charge-discharge efficiency, $\eta$, and standby losses, $\mu$.
$\eta$ is related to the efficiency of the PMU's power converters, which are quoted to have a round trip efficiency of 98\%, i.e. $\eta = 0.98$.
$\mu$ on the other hand is linked to the nominal power drawn by the battery's control system as well as the battery's self-discharge rate.
With the charge-discharge efficiency, $\eta$, the battery charge-discharge power, $p_\text{bat}(t)$, can be calculated for any given ESMU power, $\textbf{s}_\text{ESMU}(t)$ (where $(s_{\text{ESMU},\phi}(t)) = \textbf{s}_\text{ESMU}(t)$).

\input{_chapter1/equ/battery-power-definition}

\nomenclature[I]{$C_f$}{Charge factor or ``C-factor'' of the battery, where $C_f \in \mathbb{R}_{>0}$ (Chapter \ref{ch1})}

Although the ESMU's PSU rating, $S_\text{rating}$, may allow for a maximum power consumption of 36kVA (i.e. $=3\times12\text{kVA}$), the charging power is internally limited, by a charging factor, $C_f$.
This factor is the ratio between the battery's maximum discharge power and its total capacity (i.e. $\max_t (p_\text{bat}(t)) \leq C_f \cdot C_\text{bat}$).
In accordance to the ESMU's specification, $C_f$ was fixed as 1.6.
With those restrictions in mind, a charge-discharge power can be applied to charge or discharge the battery.
Assuming that this power remains constant during a predefined sample period, $\Delta t$, then the change in stored energy can be defined as follows.

\input{_chapter1/equ/change-in-energy}

\nomenclature[I]{$\mu$}{Self-discharge losses of battery, where $\mu \in (0, 1]$ (Chapter \ref{ch1})}
\nomenclature[I]{$\Delta E_\text{bat}(t)$}{Change in stored energy at time $t$, where $\Delta E_\text{bat}(t) \in \mathbb{R}$ (Chapter \ref{ch1})}
\nomenclature[I]{$SOC(t)$}{State of charge at time $t$, where $SOC(t) \in (0, 1)$ (Chapter \ref{ch1})}

The battery's dynamics can therefore be modelled as the change in energy level from time $t$ to time $t+\Delta t$.
Taking into account the standby losses, $\mu$, the next energy level $E_\text{bat}(t+\Delta t)$ is defined as:

\input{_chapter1/equ/next-energy}

In an ideal case, $\mu = 1$, where no energy would be lost in the storage system.
However, to model energy storage dynamics, it became common practice to assess the energy storage's charge level as the State of Charge (SOC) instead of using the actual charge stored.
This SOC is defined as the actual energy stored in the ESU, $E_\text{bat}(t)$, divided by the total capacity of the system, $C_\text{bat}$. i.e.:

\input{_chapter1/equ/state-of-charge-definition}

Similar to the energy dynamics, the SOC dynamics can therefore be defined as:

\input{_chapter1/equ/next-state-of-charge}

When summarising $\hat{s}_\text{ESMU}(t) = \text{Re}\left\{\sum_{\phi=1}^{\Phi}s_{\text{ESMU},\phi}(t)\right\}$ and combining Equation \ref{ch1:equ:battery-power-definition} with Equation \ref{ch1:equ:next-state-of-charge}, then the battery model's full dynamics can be defined as:

\input{_chapter1/equ/next-state-of-charge-2}

A flowchart to visually represent the developed battery model, is included in Figure \ref{ch1:fig:next-soc-flowchart}.
In this figure, all green and blue fields indicate, respectively, model inputs and results.
The white states represent operations applied onto those inputs and results and in the end yield the output, i.e. the yellow field.

\input{_chapter1/fig/next-soc-flowchart}

\subsection{ESMU scheduling}
\label{ch1:subsec:esmu-scheduling}

Computing the ESMU schedule at this resolution (or any sub-half-hourly resolution) for an entire day is very computationally demanding and highly ineffective.
Mainly, since cutting edge research in load forecasting has shown that demand variability due to behavioural unpredictability makes forecasting at high temporal resolution unfeasible, but also since traditional forecasts are generally provided at half-hourly resolution.
Therefore, the sub-half-hourly profile had to be down-sampled or extrapolated to a coarser resolution, by using a synchronisation function $k(t)$.
This function links the original sub-half-hourly to a resulting half-hourly time-series like so:

\input{_chapter1/equ/synchronisation-function}

\nomenclature[I]{$K$}{Number of blocks to downsample the sub-half-hourly profile into, where $K \in \mathbb{Z}^{>0}$ and $\frac{T_\text{sch}}{K} \in \mathbb{Z}_{>0}$ (Chapter \ref{ch1})}
\nomenclature[I]{$k(t)$}{Synchronisation function used to downsample the sub-half-hourly profile (Chapter \ref{ch1})}
\nomenclature[I]{$T_\text{sch}$}{Scheduling horizon, where $T_\text{sch} \in \mathbb{Z}_{>0}$ (Chapter \ref{ch1})}

Here, $\Delta t$ is the sampling period (i.e. minutely period) of the simulation, and $K$ is number of low-resolution blocks.
It should be noted that the integer multiple of $K$ has to equate to the scheduling horizon's length, $T_\text{sch}$; i.e. $T_\text{sch} \overset{!}{=} \alpha K \text{ where } \alpha \in \mathbb{Z}_{>0}$.
Only in this case can the sub-half-hourly profile be divided into a complete set of chunks, where each chunk is of length $K\Delta t$.
Therefore, the resulting half-hourly network load, $s^{*}_\text{net}(t)$, can be defined as follows:

\input{_chapter1/equ/down-sampling-to-half-hourly}

Since all power values from a period of $k(t)K \rightarrow (k(t)+1)K-1$ are equal, a simplified half-hourly power vector is introduced as $p_\text{net}(k)$. 
In this and any subsequent vector, half-hourly timing is indicated by using the half-hourly time $k$ instead of the sub-half-hourly time $t$, where $k \in \{1, \dots, K\}$ and $K \in \mathbb{Z}_{>0}$.
The link between $s^{*}_\text{net}(t)$ and $s_\text{net}(k)$ is therefore defined as:

\input{_chapter1/equ/half-hourly-power-profile}

From hereon, all subsequent cost functions (i.e. any $\zeta$) that deal with half-hourly profiles, are functions that use the half-hourly synchronisation function $k(t)$.
This difference will become important when differentiating between scheduling costs and the aforementioned network costs (which are based on a set of key network parameters).
Nonetheless, to illustrate how the original sub-half-hourly network load is extrapolated into the resulting half-hourly demand, both profiles are plotted in a figure below.

\input{_chapter1/fig/sub-half-horuly-demand-comparison}

In Figure \ref{ch1:fig:sub-half-horuly-demand-comparison}, it can be observed how the high variability and volatility in power is removed in the half-hourly profile.
When generating the ESMU schedules (which is addressed in Section \ref{ch1:subsec:esmu-schedule-generation}) these variations are neglected and the unwanted peak power demands are hence no longer sufficiently compensated.


As discussed in the literature review in Chapter \ref{ch-review}, the main goals when scheduling battery operation are to achieve ``valley-filling'' and ``peak-shaving'' behaviour.
It has been identified, that both the Peak-to-Average Ratio (PAR) as well as the min-max-difference (MMD) are good indicators of how well the pursued behaviours have been implemented.
Therefore, a half-hourly PAR scheduling cost, $\zeta_\text{PAR}(\textbf{s}_\text{ESMU} + \textbf{s}_\text{network load})$, and a half-hourly MMD scheduling cost, $\zeta_\text{MM}(\textbf{s}_\text{ESMU} + \textbf{s}_\text{network load})$, are defined as follows:

\input{_chapter1/equ/peak-to-average-definition}

\input{_chapter1/equ/min-max-difference-definition}

\nomenclature[I]{$\zeta_\text{PAR}(\textbf{s})$}{Cost of the underlying power profile $\textbf{s}$, based on the Peak to Average Ratio (PAR), where $\zeta_\text{PAR}(\textbf{s}) \in \mathbb{R}_{\geq0}$ (Chapter \ref{ch1})}
\nomenclature[I]{$\zeta_\text{MMD}(\textbf{s})$}{Cost of the underlying power profile $\textbf{s}$, based on the difference between Minimum and Maximum power (MM), where $\zeta_\text{MMD}(\textbf{s}) \in \mathbb{R}_{\geq0}$ (Chapter \ref{ch1})}

Both costs are functions of the entire half-hourly ESMU schedule, $\textbf{s}_\text{ESMU}$, and the entire half-hourly network load profile, $\textbf{s}_\text{network load}$, where only the ESMU schedule is adjustable by an optimisation algorithm.
For this piece of work, a Sequential Quadratic Programming (SQP) approach was chosen to solve the following minimisation problem.
Reasons behind this choice are the SQP's robustness and speed, since it is built on the well established Newton-Raphson Method, as well as its ability to cope with nonlinear constraints.
It is this latter point that is most important, since the battery model's solving constraints are inherently nonlinear; the Newton-Raphson Method by itself is unable to solve with this kind of nonlinear constraints.
The final minimisation problem that was passed into the SQP solver can be formulated as:

\input{_chapter1/equ/scheduling-cost}

To summarise, this operation therefore minimises two costs by adjusting the half-hourly ESMU schedule, $\textbf{s}_\text{ESMU}$, given a certain constant half-hourly network load (or forecast) $\textbf{s}_\text{network load}$.
These two costs both capture the PAR and MMD of the resulting power profile, and when minimised to zero, indicate a perfectly flat power curve.
The minimisation is constrained to not exceed the battery's maximum charge/discharge rate (i.e. $p_\text{bat}(k) \leq C_f \times C_\text{bat} \forall k$), to not exceed the PMU's phase power rating (i.e. $\left|s_{\text{ESMU},\phi}(k)\right| \leq S_\text{rating} \forall \phi \forall k$), and to not over- or under-charge the battery (i.e. $0 \leq SOC(k) \leq 1 \forall k$).

For the work presented in this chapter, the supplied half-hourly network load (or forecast) was extrapolated from sub-half-hourly data.
This forecast can be seen as if it had been generated with perfect foresight.
Treating it in such a way does not further skew the already imperfect performance that is obtained when applying the resulting half-hourly schedule.
Therefore, any additional improvement or worsening is the result of the sub-half-hourly schedule adjustments.
In the following figure, a visualisation is provided where the impact of this half-hourly ESMU schedule becomes apparent.

\input{_chapter1/fig/improved-network-power}

Figure \ref{ch1:fig:improved-network-power} shows the original half-hourly network load and the improved network when adding the half-hourly ESMU schedule.
For this preliminary result, no network simulations have been carried out, as it should show an idea ESMU impact on the network's load.
This positive impact can be seen, since the half-hourly profile in Figure \ref{ch1:subfig:improved-half-hourly-network-power} is dominated by an evening peak in demand.
However, the actual sub-half-hourly demand, as it is plotted in Figure \ref{ch1:subfig:improved-sub-half-hourly-network-power}, has a much larger demand spike during the morning hours, which is not addressed as strongly as the evening peak.
Therefore, the compared peak power shaving dropped from 9.46kW to only 6.36kW, although only 50\% of the battery's discharge capacity is used.
Nonetheless, the overall improvement yielded by the ESMU schedule is still noticeable (given that it was scheduled using perfect half-hourly foresight). 

In the following section, the underlying closed-loop schedule adjustment method is explained, where it will be shown how individual key network parameters can be positively impacted without deviating from this already optimised half-hourly schedule.
The constraint of having to follow this half-hourly ESMU schedule is lifted in Chapter \ref{ch2}, where a real-time schedule adjustment method is proposed and researched.
