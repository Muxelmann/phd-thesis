\begin{figure}[htb]\centering
% Define some block styles
\tikzstyle{box} = [%
	draw,%
	rectangle,%
	%fill=green!20,%
	minimum height=2em,%
	minimum width=2em,%
]
\begin{tikzpicture}[node distance=2cm, shorten >= 1pt, >=stealth', auto, scale=0.9, transform shape]
	\pgfmathsetmacro\N{4}

	% Draw input nodes
    \draw
    (0, 0) node [](input) {$p(t)$}
    (1, 0) node [](input_1) {};
    % Draw output nodes
    \draw
    (6.5, 0) node [](output) {$\hat{p}(t+\Delta t)$}
    (5, 0) node [](output_1) {};
    % Draw main adder node
    \draw (3, 0) node [circle, draw](adder_main) {+};
    % Link input, adder and output
    \draw [->] (input) to (adder_main);
    \draw [->] (adder_main) to (output);
    % Draw AR model nodes
    \foreach[count=\i, evaluate=\i as \l using int(\i*2)] \n in {1,2,...,\N}
	{
		\ifthenelse{\n<\N}
		{
	    	\draw (1, 1-\l) node [box](z_a\n) {$z^{-1}$};
	    	\draw (1, -\l) node [](half_a\n) {};
	    	\draw (1.8, -\l) node [box](a\n) {$a_\n$};
	    	
	    	\draw (5, 1-\l) node [box](z_b\n) {$z^{-1}$};
	    	\draw (5, -\l) node [](half_b\n) {};
	    	\draw (4.2, -\l) node [box](b\n) {$b_\n$};
	    	
	    	\draw (3, -\l) node [circle, draw](adder_\n) {+};
    	}{
	    	\draw (1, 1.95-\l) node [](z_a\n) {};
	    	\draw (5, 1.95-\l) node [](z_b\n) {};
    	}
    	\ifthenelse{\n=1}
    	{
    		\draw [->] (input_1.center) to (z_a\n);
    		\draw [->] (output_1.center) to (z_b\n);
    		\draw [->] (adder_\n) to (adder_main);
    	}{
    		\pgfmathtruncatemacro{\dn}{\n-1};
    		\pgfmathtruncatemacro{\dnn}{\n-2};
    		\ifthenelse{\n<\N}
			{
				\ifthenelse{\dn=1}
				{
					\draw [->] (z_a\dn) to node[left]{$p(t-\Delta t)$} (z_a\n);
				}{
					\draw [->] (z_a\dn) to node[left]{$p(t-\dn\Delta t)$} (z_a\n);
				}
				\ifthenelse{\dnn=0}
				{
					\draw [->] (z_b\dn) to node[right]{$\hat{p}(t)$} (z_b\n);
				}{
					\ifthenelse{\dnn=1}
					{
						\draw [->] (z_b\dn) to node[right]{$\hat{p}(t-\Delta t)$} (z_b\n);
					}{
						\draw [->] (z_b\dn) to node[right]{$\hat{p}(t-\dnn\Delta t)$} (z_b\n);
					}
				}
				\draw [->] (adder_\n) to (adder_\dn);
			}{
				\draw [-] (z_a\dn) to node[left]{$p(t-\dn\Delta t)$} (z_a\n.center);
				\draw [-] (z_b\dn) to node[right]{$\hat{p}(t-\dnn\Delta t)$} (z_b\n.center);
			}
    		\draw [->] (half_a\dn.center) to (a\dn);
    		\draw [->] (a\dn) to (adder_\dn);
    		\draw [->] (half_b\dn.center) to (b\dn);
    		\draw [->] (b\dn) to (adder_\dn);
    	}
    }

\end{tikzpicture}
\caption{Exogenous auto-regressive model that is used for model predictive control. Here, $z^{-1}$ indicates the time delay by one sample period, i.e. $\Delta t$.}
\label{ch2:fig:mpc-arx}
\end{figure}
